<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GSW 7 Jahrgang - Tag der offenen Tür</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            height: 100vh;
        }

        h1, p, #controlsInfo {
            margin: 5px;
            padding: 0;
        }

        canvas {
            display: none;
            margin: 20px auto;
            border: 2px solid #333;
            background-color: #87CEEB;
        }

        #score, #timer, #highscore {
            font-size: 24px;
            margin: 5px;
        }

        #gameOver {
            display: none;
            font-size: 32px;
        }

        #startButton, #hostControl {
            font-size: 24px;
            padding: 10px 20px;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 20px;
        }

        #startButton {
            background-color: #4CAF50;
        }

        #startButton:hover {
            background-color: #45a049;
        }

        #hostControl {
            background-color: #ff9800;
        }

        #hostControl:hover {
            background-color: #e68900;
        }
        
        .infoRow {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Rennspiel</h1>
    <p>GSW 7 Jahrgang - Tag der offenen Tür</p>

    <div id="controlsInfo">
        "A" oder "←" um nach links zu fahren und "D" oder "→" um nach rechts zu fahren.<br>
        Erreiche 150 Punkte um einen Baum zu pflanzen.<br>
        Drücke Leertaste, um das Spiel zu starten.
    </div>

    <canvas id="gameCanvas"></canvas>
    <div class="infoRow">
        <div id="score">Score: 0</div>
        <div id="timer">Zeit: 60</div>
        <div id="highscore">Highscore: 0</div>
    </div>
    <div id="gameOver"></div>
    <button id="startButton">Spiel Freigeben</button>
    <button id="hostControl">Spiel Freigeben</button>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('score');
        const timerDisplay = document.getElementById('timer');
        const highscoreDisplay = document.getElementById('highscore');
        const gameOverDisplay = document.getElementById('gameOver');
        const startButton = document.getElementById('startButton');
        const hostControlButton = document.getElementById('hostControl');
        const controlsInfo = document.getElementById('controlsInfo');
        canvas.width = 800;
        canvas.height = 400;

        let score = 0;
        let highscore = localStorage.getItem('highscore') || 0;  // Highscore aus localStorage laden
        let gameOver = false;
        let timeLeft = 60;
        let startDelay = 0;
        let isHostActive = false; // Ob der Host die Maussteuerung nutzt

        highscoreDisplay.innerText = `Highscore: ${highscore}`;  // Highscore anzeigen

        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.has(name) ? urlParams.get(name) : null;
        }

        const zeitParameter = getUrlParameter('zeit');
        const freeStartParameter = getUrlParameter('freeStart');

        if (zeitParameter) {
            timeLeft = parseInt(zeitParameter);
            timerDisplay.innerText = `Zeit: ${timeLeft}`;
        }

        if (freeStartParameter) {
            startDelay = parseInt(freeStartParameter);
            setTimeout(() => {
                startButton.style.display = 'block';
            }, startDelay * 1000);
        }

        let car = {
            x: canvas.width / 2 - 25,
            y: canvas.height - 80,
            width: 50,
            height: 100,
            lane: 1,
            speed: 5,
            img: new Image(),
        };
        car.img.src = 'car.png';
        car.img.onerror = () => {
            car.img.src = 'error.png';
        };

        let road = {
            width: 200,
            height: canvas.height,
            x: (canvas.width / 2) - 100,
            lanes: 3,
            laneWidth: 200 / 3,
        };

        let coins = [];
        let trees = [];
        let lastSpawnY = -800;  // Letzter Y-Spawn-Position, damit Abstände größer sind (Minimum 50px)

        function createCoin() {
            let lane = Math.floor(Math.random() * road.lanes);
            let y = Math.min(-100, lastSpawnY - 100 - Math.random() * canvas.height); // Abstand von mindestens 50px
            lastSpawnY = y;
            let coinImg = new Image();
            coinImg.src = 'coin.png';
            coins.push({
                x: road.x + lane * road.laneWidth + road.laneWidth / 2 - 15,
                y: y,
                width: 30,
                height: 30,
                collected: false,
                img: coinImg,
            });
        }

        function createTree() {
            let lane = Math.floor(Math.random() * road.lanes);
            let y = Math.min(-100, lastSpawnY - 50 - Math.random() * canvas.height); // Abstand von mindestens 50px
            lastSpawnY = y;
            let treeImg = new Image();
            treeImg.src = 'tree.png';
            trees.push({
                x: road.x + lane * road.laneWidth + road.laneWidth / 2 - 30,
                y: y,
                width: 60,
                height: 100,
                img: treeImg,
            });
        }

        function drawCar() {
            car.x = road.x + car.lane * road.laneWidth + road.laneWidth / 2 - car.width / 2;
            ctx.drawImage(car.img, car.x, car.y, car.width, car.height);
        }

        function drawRoad() {
            ctx.fillStyle = 'gray';
            ctx.fillRect(road.x, 0, road.width, road.height);
            ctx.strokeStyle = 'white';
            ctx.setLineDash([20, 15]);
            ctx.lineWidth = 5;
            ctx.beginPath();
            for (let i = 1; i < road.lanes; i++) {
                ctx.moveTo(road.x + i * road.laneWidth, 0);
                ctx.lineTo(road.x + i * road.laneWidth, road.height);
            }
            ctx.stroke();
        }

        function drawCoins() {
            coins.forEach(coin => {
                if (!coin.collected) {
                    ctx.drawImage(coin.img, coin.x, coin.y, coin.width, coin.height);
                }
            });
        }

        function drawTrees() {
            trees.forEach(tree => {
                ctx.drawImage(tree.img, tree.x, tree.y, tree.width, tree.height);
            });
        }

        function updateCoins() {
            coins.forEach(coin => {
                coin.y += car.speed;
                if (coin.y > canvas.height) {
                    coins.splice(coins.indexOf(coin), 1);
                }
                if (!coin.collected &&
                    coin.x < car.x + car.width &&
                    coin.x + coin.width > car.x &&
                    coin.y < car.y + car.height &&
                    coin.y + coin.height > car.y) {
                    coin.collected = true;
                    score += 10;
                    scoreDisplay.innerText = `Score: ${score}`;
                }
            });
        }

        function updateTrees() {
            trees.forEach(tree => {
                tree.y += car.speed;
                if (tree.y > canvas.height) {
                    trees.splice(trees.indexOf(tree), 1);
                }
                if (tree.x < car.x + car.width &&
                    tree.x + tree.width > car.x &&
                    tree.y < car.y + car.height &&
                    tree.y + tree.height > car.y) {
                    endGame();
                }
            });
        }

        function endGame() {
            gameOver = true;
            if (score >= 150) {
                gameOverDisplay.innerText = `Gewonnen! Dein Score: ${score}`;
                gameOverDisplay.style.color = 'green'; // Grün, wenn gewonnen
            } else {
                gameOverDisplay.innerText = `Game Over! Dein Score: ${score}`;
                gameOverDisplay.style.color = 'red'; // Rot, wenn verloren
            }
            gameOverDisplay.style.display = 'block';

            if (score > highscore) {
                highscore = score;
                localStorage.setItem('highscore', highscore);  // Highscore speichern
                highscoreDisplay.innerText = `Highscore: ${highscore}`;
            }

            startButton.innerText = "Spiel Freigeben"; // Button zurücksetzen
            hostControlButton.innerText = "Spiel Freigeben"; // Button zurücksetzen
            setTimeout(() => {
                startButton.style.display = 'block';
            }, 5000);
        }

        function updateGame() {
            if (gameOver) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawRoad();
            drawCar();
            drawCoins();
            drawTrees();
            updateCoins();
            updateTrees();

            if (Math.random() < 0.02) createCoin();
            if (Math.random() < 0.01) createTree();

            requestAnimationFrame(updateGame);
        }

        function startTimer() {
            const timer = setInterval(() => {
                if (gameOver || timeLeft <= 0) {
                    clearInterval(timer);
                    if (!gameOver) endGame();
                } else {
                    timeLeft--;
                    timerDisplay.innerText = `Zeit: ${timeLeft}`;
                }
            }, 1000);
        }

        // Host und Gast Steuerung
        document.addEventListener('keydown', (event) => {
            if (!gameOver) {
                if ((event.key === 'ArrowLeft' || event.key === 'a') && car.lane > 0) {
                    car.lane--;
                }
                if ((event.key === 'ArrowRight' || event.key === 'd') && car.lane < road.lanes - 1) {
                    car.lane++;
                }
                if (event.key === ' ' && startButton.style.display !== 'none') {
                    startGame();
                }
            }
        });

        hostControlButton.addEventListener('click', () => {
            isHostActive = true;
            hostControlButton.innerText = "Spiel Aktiv";
        });

        canvas.addEventListener('mousemove', (event) => {
            if (isHostActive && !gameOver) {
                let relativeX = event.clientX - canvas.getBoundingClientRect().left;
                let laneWidth = road.laneWidth;
                let lane = Math.floor((relativeX - road.x) / laneWidth);
                if (lane >= 0 && lane < road.lanes) {
                    car.lane = lane;
                }
            }
        });

        function startGame() {
            startButton.style.display = 'none';
            canvas.style.display = 'block';
            score = 0;
            timeLeft = zeitParameter ? parseInt(zeitParameter) : 60;
            gameOver = false;
            gameOverDisplay.style.display = 'none';
            scoreDisplay.innerText = `Score: 0`;
            timerDisplay.innerText = `Zeit: ${timeLeft}`;
            controlsInfo.style.display = 'none'; // Anleitung verstecken
            startTimer();
            updateGame();

            // Buttons umbenennen
            startButton.innerText = "Spiel Aktiv";
            hostControlButton.innerText = "Spiel Aktiv";
        }

        startButton.addEventListener('click', startGame);
    </script>
</body>
</html>
